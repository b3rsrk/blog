---
layout: post
title: 'Store files in the IOTA Tangle'
comments: true
date: 2018-2-14 0:0:0
keywords: "iota, tangle, crypto, storage, p2p, dev"
category: crypto
tags:
- iota
- tangle
- crypto
- storage
- p2p
- dev
---

**tl;dr:** I implemented a javascript file storage application based on the [IOTA](https://iota.org) Tangle. It is intended as a coin-less alternative for the [Oyster](https://oysterprotocol.com/) protocol. You can find a working demo at [storgle.io](https://storgle.io/).

While doing research on decentralized and blockchain based file storage solutions, my colleague and I stumbled across Oyster. It describes itself as: *»The future of website monetization and distributed storage, built on IOTA Tangle and [Ethereum](https://www.ethereum.org)«*. Yet another example of how even the tiniest technical idea leads to a ridiculous complex protocol described in a bad looking [whitepaper](https://oyster.ws/OysterWhitepaper.pdf), which then can be advertised in marketing campaigns. If I imagine *»the future of distributed storage«*, I would never come up with the idea to save files in the payload space of transactions of an other cryptocoin. There are already promising and good designed examples of distributed storage systems like [Sia](https://sia.tech/). Even the good old [BitTorrent](http://www.bittorrent.com/) protocol is a better example (even without any coin you can trade on shady exchanges).

Blockchain size and growth is a big problem in cryptocurrencies. Thats why the majority of coins implement a size-based transaction fee. If you imagine that you can store arbitrary data in a [Bitcoin](https://bitcoin.org) transaction without any overhead (not possible), it will cost you at this moment about 800$ to store a 100KB file in the Bitcoin blockchain. Pretty expensive, huh? But this is where the IOTA Tangle gets interesting. IOTA implements transaction fees not in form of value to spend, but in Proof-of-Work to do. You have to do a relatively small amount of PoW for every transaction you publish to the network. Another key-point is, that you can fit 1094 byte of arbitrary data with just a little bit overhead of 243 bytes (22%) in a transaction. Additional, IOTA also allows Zero-Value-Transactions, where you don't have to spend any value. Optimal conditions for a simple file storage on top of the Tangle. Semi-optimal conditions from the IOTA network perspective. The network will benefit from the large amount of transactions generated by a file storage system ([thread on reddit.com](https://www.reddit.com/r/Iota/comments/6zcrj3/want_to_help_the_iota_network_i_made_a_simple/)). But it will definitely bloat the Tangle when used by many. Imagine that each file you upload will be stored on every full-node in the network. IOTA plans to make "snapshots", to reduce the size of the tangle, when it's to big to store ([post on iota-news.com](https://iota-news.com/iota-snapshot/)). Based on how regular these snapshots happen, this could solve the Tangle bloat.

Files included in transactions will be deleted when snapshots are made. Oyster's solution for this problem is that they reattach files when they get deleted. In my option: Sounds good, doesn't work.

<div class="post-image"><img src="/assets/images/trump.gif"></div>

When a snapshot is announced, the Oyster protocol has to download all attached files and then reattach them. For reattaching, this needs, based on how much data is attached, a lot of time or o lot of computing power. Let's say all Oyster users have uploaded 138TB (this is storage used in Sia at this moment) of data and a snapshot is announced in two weeks. The Oyster network then have to provide 800,000 times of the computing power of my laptop and that 24/14. That are 280 million hours of mining.

When talking about mining, Oyster uses it to create *»the future of website monetization«*. Websites should include a webmining script and get payed in Ethereum for it. Nothing new, [Coinhive](https://coinhive.com) provides this with [Monero](https://getmonero.org) mining since a few month. The problem is that these scripts get blocked by adblockers and AVs. And the mining power of webminers is not optimal for hash based PoW. Monero uses a "memory-hard" algorithm, which is more efficient when done in a browser.

But after all that, I like the basic concept of the Oyster protocol: Abusing transaction payload space to store arbitrary data in a Blockchain (or Tangle). Not to revolutionize online file storage, but to demonstrate why this is a bad idea and where the Oyster protocol has principal conceptual problems. Here are my up- and downsides:

#### Pros:
* High redundancy file storage (depending on the amount of full-nodes)
* Good anonymity when uploading, perfect when downloading
* Nice weekend project when implementing a Proof-of-Concept

#### Cons:
* Tangle bloat
* Slow upload speeds (about 150bytes/s on my notebook)
* Possible inconsistencies when snapshots are made

## Implementation

I decided to give it a try and implement a Proof-of-Concept for storing files in the IOTA Tangle. It took me a weekend to complete the demo. I definitely noticed that I'm a lot slower since I'm not coding for a living anymore. You can find a working demo at [storgle.io](https://storgle.io) and the code in my [Github repository](https://github.com/b3rsrk/storgle).

<div class="post-image"><img src="/assets/images/screenshot.png"></div>

The whole application is client sided. You can even download it and run locally. The "frontend" is made with [Vue.js](https://vuejs.org/) and [Bootstrap](https://getbootstrap.com/). The magic happens at ```storgle.js```, which mainly uses the IOTA API library [iota.lib.js](https://github.com/iotaledger/iota.lib.js).

```javascript
function transfer_chunk() {
  eventEmitter.emitEvent('log', [`Processing transaction #${transaction_index}.`])

  iota.api.sendTrytes([transactions[transaction_index]], Math.floor(Math.random() * (12 - 4 + 1)) + 4, 14, function(error, success){
    if (error) {
      eventEmitter.emitEvent('log', [`Error occurred while sending transactions: ${error}`])
      setTimeout(function(){
        reinitialize(transfer_chunk)
      }, 1000)
      return
    }

    transaction_index++
    bundle = success[0].bundle;
    eventEmitter.emitEvent('progress', [Math.ceil((transaction_index)/transactions.length*100)])
    eventEmitter.emitEvent('bundle', [bundle])
    eventEmitter.emitEvent('log', [`Commited transaction ${success[0].hash}`])
    if(transaction_index != transactions.length) {
      transfer_chunk();
    } else {
      eventEmitter.emitEvent('log', [`Upload complete.`])
    }
  });
}
```

I also implemented a simple ```AES-128-CTR``` Encryption with [aes-js](https://github.com/ricmoo/aes-js), which encrypts the files before they are uploaded and decrypts them when they are downloaded.

```javascript
function toTrytes(buffer) {
  let view = new Uint8Array(buffer);

  if(password_key != undefined)
    view = new aesjs.ModeOfOperation.ctr(password_key, new aesjs.Counter(5)).encrypt(view);

  var str = '';

  for (var i = 0; i < view.length; i++) {
    var firstValue = view[i] % 27;
    var secondValue = (view[i] - firstValue) / 27;
    str += tryteAlphabet[firstValue] + tryteAlphabet[secondValue];
  }

  return str
}

function fromTrytes(inputTrytes) {
  let view = new Uint8Array(inputTrytes.length/2);

  for (var i = 0; i < inputTrytes.length; i+=2) {
    var trytes = inputTrytes[i] + inputTrytes[i + 1];
    var firstValue = tryteAlphabet.indexOf(trytes[0]);
    var secondValue = tryteAlphabet.indexOf(trytes[1]);
    view[i/2] = firstValue + secondValue * 27;
  }

  if(password_key != undefined)
    view = new aesjs.ModeOfOperation.ctr(password_key, new aesjs.Counter(5)).decrypt(view);

  return btoa(String.fromCharCode.apply(null, view));
}
```

## Final words

I'd a fun weekend implementing the demo. But I think thats all it is: a demo. I like minimalistic and lightweight software, but the current blockchain boom brings people into over-thinking problems when they try to make a coin out of it.

Special thanks to my college [@kAhmij](https://twitter.com/kahmij)!

While writing this post, I found a similar projects I wasn't aware of: [iota-storage.net](http://iota-storage.net/) and [tanglesta.sh](http://tanglesta.sh/)

#### Contributing

If you found some mistake, you can help by opening [pull-requests](https://github.com/b3rsrk/blog/pulls).
